rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Default deny all access
    match /{document=**} {
      allow read, write: if false;
    }
    
    // API Keys collection - IAM-based authentication
    match /api_keys/{keyHash} {
      // Simple approach: let IAM handle authorization, just verify authentication
      // The service account already has minimal permissions via Terraform IAM
      allow read, write: if request.auth != null 
        && request.auth.uid != null;
    }
    
    // Audit logs collection - write-only for service account
    match /audit_logs/{logId} {
      allow write: if request.auth != null 
        && request.auth.uid != null;
      
      // Admin read access
      allow read: if request.auth != null 
        && request.auth.uid != null;
    }
    
    // Compliance events collection
    match /compliance_events/{eventId} {
      allow write: if request.auth != null 
        && request.auth.uid != null;
      
      allow read: if request.auth != null 
        && request.auth.uid != null;
    }
    
    // Analytics collection - write-only for metrics
    match /analytics/{analyticsId} {
      allow write: if request.auth != null 
        && request.auth.uid != null;
      
      // No read access - analytics should be processed separately
      allow read: if false;
    }
  }
}